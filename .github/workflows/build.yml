name: Build Calibre Companion

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        submodules: recursive
    
    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y cmake build-essential git libmpfr-dev libgmp-dev libmpc-dev
    
    - name: Clone PocketBook SDK
      run: |
        mkdir -p SDK
        cd SDK
        git clone --depth 1 --branch 5.19 https://github.com/pocketbook/SDK_6.3.0.git
    
    - name: Setup SDK environment
      run: |
        # Create symlinks for required libraries
        sudo ln -sf /usr/lib/x86_64-linux-gnu/libmpfr.so.6 /usr/lib/x86_64-linux-gnu/libmpfr.so.4 || true
        sudo ln -sf /usr/lib/x86_64-linux-gnu/libgmp.so.10 /usr/lib/x86_64-linux-gnu/libgmp.so.3 || true
        sudo ldconfig
    
    - name: Create build directory
      run: mkdir -p build
    
    - name: Configure CMake
      run: |
        cd build
        cmake .. -DCMAKE_TOOLCHAIN_FILE=../toolchain.cmake
    
    - name: Build
      run: |
        cd build
        cmake --build . --config Release
    
    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: calibre-companion
        path: build/calibre-companion.app
        
    - name: Create release on tag
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v2
      with:
        files: build/calibre-companion.app
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
