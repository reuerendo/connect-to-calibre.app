name: Build Calibre Companion

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        submodules: recursive
    
    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y cmake build-essential git libmpfr-dev libgmp-dev libmpc-dev libarchive-tools curl
    
    - name: Download and extract PocketBook SDK 6.8
      run: |
        mkdir -p SDK
        cd SDK
        curl -L -o SDK-B288-6.8.7z https://github.com/pocketbook/SDK_6.3.0/releases/download/6.8/SDK-B288-6.8.7z
        mkdir -p SDK_6.3.0
        bsdtar -xf SDK-B288-6.8.7z -C SDK_6.3.0
        rm SDK-B288-6.8.7z
    
    - name: Setup SDK environment
      run: |
        # Create symlinks for required libraries
        sudo ln -sf /usr/lib/x86_64-linux-gnu/libmpfr.so.6 /usr/lib/x86_64-linux-gnu/libmpfr.so.4 || true
        sudo ln -sf /usr/lib/x86_64-linux-gnu/libgmp.so.10 /usr/lib/x86_64-linux-gnu/libgmp.so.3 || true
        sudo ldconfig
    
    - name: Clean previous build
      run: |
        rm -rf build
    
    - name: Create build directory
      run: mkdir -p build
    
    - name: Configure CMake
      run: |
        cd build
        cmake .. -DCMAKE_TOOLCHAIN_FILE=../toolchain.cmake -DCMAKE_BUILD_TYPE=Release
    
    - name: Build
      run: |
        cd build
        cmake --build . --config Release --verbose
    
    - name: Check binary size
      run: |
        ls -lh build/connect-to-calibre.app
        file build/connect-to-calibre.app
    
    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: connect-to-calibre
        path: build/connect-to-calibre.app
        
    - name: Create release on tag
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v2
      with:
        files: build/connect-to-calibre.app
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
